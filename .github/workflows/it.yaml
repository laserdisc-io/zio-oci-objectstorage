name: Integration Tests
on:
  pull_request_target:
    types: [labeled]

env:
  OCI_PRIVATE_KEY: /tmp/oci_key.pem

jobs:
  integrationTests:
    name: Integration Tests
    if: contains(github.event.pull_request.labels.*.name, 'safe for integration tests')
    strategy:
      matrix:
        scala: [2.12.15, 2.13.8]
        java:
          - adopt@1.11
          - adopt@1.15
        os: [ubuntu-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Branch Checkout
        uses: actions/checkout@v2.3.4
        with:
          fetch-depth: 0

      - name: Setup Java and Scala
        uses: olafurpg/setup-scala@v13
        with:
          java-version: ${{ matrix.java }}

      - name: Cache
        uses: actions/cache@v2
        with:
          path: |
            $HOME/.cache/coursier
            $HOME/.ivy2/cache
            $HOME/.sbt/boot/
            $HOME/.sbt
            lib_managed
            target
            project/target
          key: ${{ runner.os }}-cache-v2-${{ hashFiles('**/*.sbt') }}-${{ hashFiles('project/build.properties') }}

      - name: Set up OCI key
        run: echo $OCI_PRIVATE_KEY_BASE64 | base64 -d > $OCI_PRIVATE_KEY
        env:
          OCI_PRIVATE_KEY_BASE64: ${{ secrets.OCI_PRIVATE_KEY_BASE64 }}

      - name: Test (${{ matrix.scala }}, ${{ matrix.java }})
        run: sbt ++${{ matrix.scala }} "IntegrationTest / test"
        env:
          OCI_USER_ID: ${{ secrets.OCI_USER_ID }}
          OCI_TENANT_ID: ${{ secrets.OCI_TENANT_ID }}
          OCI_FINGERPRINT: ${{ secrets.OCI_FINGERPRINT }}
